const Telegraf = require('telegraf');
const { Extra, Markup } = require('telegraf');
const http = require('http');
const MongoClient = require('mongodb').MongoClient;
const Route = require('../models/route');
const endHandler = require('../handlers/endHandler');

module.exports = function(bot){

    bot.action(/find(.+)/, function(ctx) {

        var message = ctx.callbackQuery.data.split(':')[1];
        
        var latitude = message.location.latitude;
        var longitude = message.location.longitude;
        var smallestDistance = 0;
        var nearestBusStop = new String();
        
        MongoClient.connect('mongodb://rebstan97:orbitalbus@ds151232.mlab.com:51232/orbitalbot', function(err, db) {

            if (err) throw err;

            db.collection("busstops").find().forEach(function(busStops){
                
                var distance = Math.pow(busStops.latitude - latitude, 2) + Math.pow(busStops.longtitude - longtitude, 2);
                
                if(distance < smallestDistance){
                    smallestDistance = distance;
                    nearestBusStop = busStops.name;
                };
                
                db.close();
                
             });
             
            ctx.reply('My dear, your nearest bus stop is ' + nearestBusStop,
                Markup.inlineKeyboard([Markup.callbackButton(nearestBusStop, `end:nearestBusStop:${source}`)])
            );
        
            return endHandler(bot);
        
        });
        
    });
    
};
